name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  build-and-analyze:
    name: Build and analyze (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    container: ${{ matrix.image }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: ubuntu-24.04
            os: ubuntu-24.04
            image: ubuntu:24.04
            install: |
              set -eux
              export DEBIAN_FRONTEND=noninteractive
              apt-get update
              apt-get install -y --no-install-recommends \
                ca-certificates \
                build-essential \
                ca-certificates \
                clang \
                clang-tidy \
                cppcheck \
                cmake \
                git \
                pkg-config \
                libvlc-dev \
                libvlccore-dev \
                vlc-plugin-base
          - label: fedora-40
            os: ubuntu-latest
            image: fedora:40
            install: |
              set -eux
              dnf -y update
              dnf -y install \
                ca-certificates \
                @development-tools \
                ca-certificates \
                clang-tools-extra \
                cppcheck \
                cmake \
                git \
                pkg-config \
                vlc-devel
          - label: macos-latest
            os: macos-latest
            install: |
              brew install cmake vlc
          - label: windows-latest
            os: windows-latest
            install: |
              choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
              # VLC is hard to install dev headers on Windows via choco, we rely on mocks for tests
              # and optional VLC build (if handled by CMake)
    steps:
      - name: Install system dependencies
        if: runner.os == 'Linux'
        run: ${{ matrix.install }}

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: ${{ matrix.install }}

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: ${{ matrix.install }}

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: cmake --build build --config RelWithDebInfo

      - name: Run unit tests
        run: ctest --test-dir build --output-on-failure

      - name: Run clang-tidy
        if: runner.os == 'Linux'
        run: clang-tidy -p build library.c tag_utils.c

      - name: Run cppcheck
        if: runner.os == 'Linux'
        run: cppcheck --enable=warning,performance,style --std=c11 --inline-suppr --suppress=missingIncludeSystem --project=build/compile_commands.json
